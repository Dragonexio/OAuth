# 支付相关接口



## 接入方申请支付文档

1. 申请支付（用户向接入方支付）
    - 请求方式：POST，由接入方服务端调用
    - url：`https://{host}/api/v1/pay/user2app/pre/`
    - 传入值：

        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | trade_no | string | 转账流水号，接入方需保证唯一，只允许数字、字母、下划线，最长64个字节 |
        | coin_code | string | 支付币种，如：usdt, dt |
        | volume | string | 支付数量 |
        | scene | string | 支付场景，100个字符以下 |
        | desc | string | 支付描述信息，100个字符以下 |
        | device | string | 申请支付的设备信息，长度[8, 16]个字符之间 |
        | state | string | 长度[8, 16]个字符之间，用于防止CSRF攻击，可用随机字符串或其他方式生成的不可预测的字符串，且使用后立即失效 |
        | redirect_url | string | 支付成功或失败后，浏览器跳转到的接入方的链接，以`https://`或`http://`打头 |
        | domain | string | 当前用户使用的DragonEx域名，DragonEx前端跳转到接入方页面时会带上此字段，原样传过来即可 |
    - 返回值data信息：
        
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | pay_url | string | 跳转到支付的地址，支付地址中会带有以下查询参数 |
        - pay_url中带有的参数
        
            | 字段名 | 数据类型 | 说明 |
            | --- | --- | --- |
            | app_id | string | 发起支付的接入方的AppId |
            | trade_no | string | 转账流水号，接入方需保证唯一，只允许数字、字母、下划线，最长64个字节 |
            | coin_code | string | 支付币种，如：usdt, dt |
            | volume | string | 支付数量 |
            | scene | string | 支付场景 |
            | desc | string | 支付描述信息 |
            | device | string | 发起支付的设备信息 |
            | state | string | 随机字符串 |
            | code | string | 支付Code |
            | expire_time | int | 支付code的有效期，秒级时间戳 |
            | redirect_url | string | 支付成功或失败后，浏览器跳转到的接入方的链接 |
    - 示例
    
        ```json
        {
          "code": 1,
          "msg": "",
          "ok": true,
          "Data": {
            "pay_url": "https://oauth.dragonex.im/oauth/pay?app_id=appidfortest&code=c77685c94d&coin_code=usdt&device=deviceForTest&expire_time=1551348353&scene=sceneForTest&state=stateForTest&trade_no=21&volume=1&redirect_url=https://xxx.xxx.xxx"
          }
        }
        ```
        
## 接入方需提供的跳转页面

1. 用户支付成功（或失败）后跳到的接入方地址
    - 请求方式：浏览器跳转
    - url：上述接入方申请支付时传入的redirect_url字段
    - 传入值（通过url查询参数传递）：
    
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | id | int | 此订单在DragonEx的唯一标识 |
        | uid | int | 此次实际付款用户的DragonExUid |
        | coin_code | string | 支付币种 |
        | volume | string | 支付总数量 |
        | cut_volume | string | 收取佣金数量 |
        | trade_no | string | 转账流水号，接入方需保证唯一，只允许数字、字母、下划线，最长64个字节 |
        | direction | int | 订单方向 |
        | status | int | [订单状态][payorderstatus]，用户取消支付时，此处的status值为-1 |
        | state | string | 申请支付时传递给服务端的随机字符串 |
    - 返回值data信息：浏览器跳转，后续由接入方处理


## 接入方需提供的支付回调

1. 用户支付成功后的回调地址
    - 请求方式：POST方法
    - url：app管理员设置的回调地址
    - 传入值：
    
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | id | int | 此订单在DragonEx的唯一标识 |
        | uid | int | 此次实际付款用户的DragonExUid |
        | coin_code | string | 支付币种 |
        | volume | string | 支付数量 |
        | cut_volume | string | 收取佣金数量 |
        | trade_no | string | 转账流水号 |
        | direction | int | 订单方向 |
        | status | int | [订单状态][payorderstatus] |
    - 返回值data信息：无
    - 注意：**返回200状态码即认为回调成功，若不成功在36H内每隔10min重试一次**

## DragonEx服务端接口

1. 从接入方转账给用户
    - 请求方式：POST，由接入方服务端调用
    - url：`https://{host}/api/v1/pay/app2user/do/`
    - 传入值：

        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | trade_no | string | 转账流水号，接入方需保证唯一，只允许数字、字母、下划线，最长64个字节 |
        | open_id | string | 用户的OpenId，在接入方有使用龙网登录时可使用此参数 |
        | uid | int | 要转账给用户的DragonExUid，在接入方没有使用龙网登录，且知道用户uid时可以使用此参数，open_id与uid必选其一 |
        | coin_code | string | 支付币种，如：usdt, dt |
        | volume | string | 支付数量 |
        | scene | string | 支付场景 |
        | desc | string | 支付描述信息 |
        | device | string | 发起支付的设备信息 |
    - 返回值data信息：
        
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | id | int | 此订单在DragonEx的唯一标识 |
        | arrive_time | int | 到帐时间，纳秒级时间戳，未入账则为0 |
        | coin_code | string | 支付币种 |
        | create_time | string | 申请支付时间，纳秒级时间戳 |
        | direction | int | 方向 |
        | status | int | 支付状态 |
        | trade_no | string | 交易流水号 |
        | uid | int | DragonEx Uid |
        | volume | string | 支付数量 |
        | cut_volume | string | 收取佣金数量 |
    - 示例
    
        ```json
        {
          "code": 1,
          "msg": "",
          "ok": true,
          "Data": {
            "id": 1000001,
            "arrive_time": 0,
            "coin_code": "usdt",
            "create_time": 1551351330000000000,
            "direction": 2,
            "status": 3,
            "trade_no": "25",
            "uid": 1000000,
            "volume": "1",
            "cut_volume": "0"
          }
        }
        ```
        
1. 查询订单详情
    - 请求方式：POST，由接入方服务端调用
    - url：`https://{host}/api/v1/pay/order/detail/`
    - 传入值：

        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | trade_no | string | 转账流水号，接入方需保证唯一，只允许数字、字母、下划线，最长64个字节 |
    - 返回值data信息：
        
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | id | int | 此订单在DragonEx的唯一标识 |
        | arrive_time | int | 到帐时间，纳秒级时间戳，未入账则为0 |
        | coin_code | string | 支付币种 |
        | create_time | string | 申请支付时间，纳秒级时间戳 |
        | direction | int | 方向 |
        | status | int | 支付状态 |
        | trade_no | string | 交易流水号 |
        | uid | int | DragonEx Uid |
        | volume | string | 支付数量 |
        | cut_volume | string | 收取佣金数量 |

    - 示例
    
        ```json
        {
          "code": 1,
          "msg": "",
          "ok": true,
          "Data": {
            "id": 1000001,
            "arrive_time": 0,
            "coin_code": "usdt",
            "create_time": 1551351330000000000,
            "direction": 2,
            "status": 3,
            "trade_no": "25",
            "uid": 1000000,
            "volume": "1",
            "cut_volume": "0"
          }
        }
        ```

1. 查询订单详情
    - 请求方式：GET或POST，由接入方客户端调用，只能查询属于当前用户的
    - url：`https://{host}/api/v1/pay/order/detail/`
    - 传入值：

        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | trade_no | string | 转账流水号，接入方需保证唯一，只允许数字、字母、下划线，最长64个字节 |
    - 返回值data信息：
        
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | id | int | 此订单在DragonEx的唯一标识 |
        | arrive_time | int | 到帐时间，纳秒级时间戳，未入账则为0 |
        | coin_code | string | 支付币种 |
        | create_time | string | 申请支付时间，纳秒级时间戳 |
        | direction | int | 方向 |
        | status | int | 支付状态 |
        | trade_no | string | 交易流水号 |
        | uid | int | DragonEx Uid |
        | volume | string | 支付数量 |
        | cut_volume | string | 收取佣金数量 |

    - 示例
    
        ```json
        {
          "code": 1,
          "msg": "",
          "ok": true,
          "Data": {
            "id": 1000001,
            "arrive_time": 0,
            "coin_code": "usdt",
            "create_time": 1551351330000000000,
            "direction": 2,
            "status": 3,
            "trade_no": "25",
            "uid": 1000000,
            "volume": "1",
            "cut_volume": "0"
          }
        }
        ```
        
1. 查询历史订单
    - 请求方式：POST，由接入方服务端调用
    - url：`https://{host}/api/v1/pay/order/history/`
    - 传入值：

        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | coin_code | string | 支付币种，如：usdt, dt，传空字符串`""`获取所有用户 |
        | uid | string | 要查询的用户DragonEx Uid，传`0`获取所有用户 |
        | direction | int | [转帐方向][payorderdirection]，传0则不作此条件筛选 |
        | start_time | int | 查询起始时间，传0不做起始时间限制，秒级时间戳 |
        | end_time | int | 查询结束时间，传0不做结束时间限制，秒级时间戳 |
        | offset | int | 偏移 |
        | limit | int | 查询条数，每次最多20条 |
    - 返回值data信息：
        
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | total | int | 总条数 |
        | list | [] | 订单明细 |
        - list信息：
            
            | 字段名 | 数据类型 | 说明 |
            | --- | --- | --- |
            | id | int | 此订单在DragonEx的唯一标识 |
            | arrive_time | int | 到帐时间，纳秒级时间戳，未入账则为0 |
            | coin_code | string | 支付币种 |
            | create_time | string | 申请支付时间，纳秒级时间戳 |
            | direction | int | 方向 |
            | status | int | 支付状态 |
            | trade_no | string | 交易流水号 |
            | uid | int | DragonEx Uid |
            | volume | string | 支付数量 |
            | cut_volume | string | 收取佣金数量 |

    - 示例
    
        ```json
        {
          "code": 1,
          "msg": "",
          "ok": true,
          "Data": [
            {
              "id": 1000001,
              "arrive_time": 0,
              "coin_code": "usdt",
              "create_time": 1551351330000000000,
              "direction": 2,
              "status": 3,
              "trade_no": "25",
              "uid": 1000000,
              "volume": "1",
              "cut_volume": "0"
            }
          ]
        }
        ```

1. 查询历史订单，只能查询当前用户的
    - 请求方式：GET或POST，由接入方客户端调用
    - url：`https://{host}/api/v1/pay/order/history/`
    - 传入值：

        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | coin_code | string | 支付币种，如：usdt, dt，传空字符串`""`获取所有用户 |
        | direction | int | [转帐方向][payorderdirection]，传0则不作此条件筛选 |
        | start_time | int | 查询起始时间，传0不做起始时间限制，秒级时间戳 |
        | end_time | int | 查询结束时间，传0不做结束时间限制，秒级时间戳 |
        | offset | int | 偏移 |
        | limit | int | 查询条数，每次最多20条 |
    - 返回值data信息：
        
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | total | int | 总条数 |
        | list | [] | 订单明细 |
        - list信息：
            
            | 字段名 | 数据类型 | 说明 |
            | --- | --- | --- |
            | id | int | 此订单在DragonEx的唯一标识 |
            | arrive_time | int | 到帐时间，纳秒级时间戳，未入账则为0 |
            | coin_code | string | 支付币种 |
            | create_time | string | 申请支付时间，纳秒级时间戳 |
            | direction | int | 方向 |
            | status | int | 支付状态 |
            | trade_no | string | 交易流水号 |
            | uid | int | DragonEx Uid |
            | volume | string | 支付数量 |
            | cut_volume | string | 收取佣金数量 |

    - 示例
    
        ```json
        {
          "code": 1,
          "msg": "",
          "ok": true,
          "Data": [
            {
              "id": 1000001,
              "arrive_time": 0,
              "coin_code": "usdt",
              "create_time": 1551351330000000000,
              "direction": 2,
              "status": 3,
              "trade_no": "25",
              "uid": 1000000,
              "volume": "1",
              "cut_volume": "0"
            }
          ]
        }
        ```
        
1. 接入方主动要求某支付记录发起回调（不论支付是否成功，也不论之前是否已回调，均会再次发起回调）
    - 请求方式：POST，由接入方服务端调用
    - url：`https://{host}/api/v1/pay/callback/redo/`
    - 传入值：

        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | trade_no | string | 发起支付转帐时的trade_no |
    - 返回值data信息：无

    - 示例
    
        ```json
        {
          "code": 1,
          "msg": "",
          "ok": true,
          "Data": {}
        ```

[payorderstatus]: <./5.附录.md/#订单状态> "订单状态"
[payorderdirection]: <./5.附录.md/#转帐方向> "转帐方向"
[scopes]: <./5.附录.md/#权限> "可申请权限"
[用户支付成功或失败后跳转到的接入方地址]: <#接入方需提供的跳转页面>














