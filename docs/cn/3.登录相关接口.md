# 登录相关接口

## 接入方请求DragonEx提供的前端页面

1. 访问DragonEx授权登录页面
    - 请求方式：接入方请求DragonEx前端页面，浏览器跳转，GET请求
    - url：`https://{host}/oauth/login/`
    - 传入值（通过url查询参数传递）：
    
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | app_id | string | 接入方AppId |
        | scopes | string | [申请的权限][scopes]，此次登录申请的权限，多个用`,`分隔 |
        | state | string | 长度[8, 16]个字符之间，用于防止CSRF攻击，可用随机字符串或其他方式生成的不可预测的字符串，且使用后立即失效 |
        | device | string | 申请登录的设备信息，长度[8, 16]个字符之间，获取的AccessToken会与此设备绑定，若后续请求时的AccessToken与device不对应会拒绝请求 |
        | redirect_url | string | 拿到AccessCode后，浏览器跳转到的[接入方的链接][] |
    - 返回值data信息：浏览器跳转，后续由DragonEx处理


## 接入方需提供的跳转页面

1. 用户同意登录授权，拿到AccessCode后跳转到的接入方地址
    - 请求方式：浏览器跳转
    - url：上述接入方访问DragonEx授权登录页面时传入的redirect_url字段
    - 传入值（通过url查询参数传递）：
    
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | code | string | 申请登录授权时拿到的AccessCode |
        | expire_time | int | AccessCode的过期时间，秒级时间戳 |
        | scopes | string | [访问DragonEx授权登录页面][]传入的scopes字段 |
        | state | string | [访问DragonEx授权登录页面][]传入的state字段 |
        | device | string | [访问DragonEx授权登录页面][]传入的device字段 |
    - 返回值data信息：浏览器跳转，后续由接入方处理

## DragonEx服务端接口

1. 授权登录
    - 请求方式：POST，接入方服务端调用
    - url：`https://{host}/api/v1/login/do/`
    - 传入值：

        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | code | string | 申请登录授权时拿到的AccessCode |
        | app_id | string | [访问DragonEx授权登录页面][]传入的app_id字段 |
        | scopes | string | [访问DragonEx授权登录页面][]传入的scopes字段 |
        | state | string | [访问DragonEx授权登录页面][]传入的state字段 |
        | device | string | [访问DragonEx授权登录页面][]传入的device字段 |
    - 返回值data信息：
        
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | code | string | 申请登录授权时拿到的AccessCode |
        | access_token | string | 授权登录拿到的AccessToken |
        | access_token_et | int | AccessToken有效期，秒级时间戳 |
        | refresh_token | string | 授权登录拿到的RefreshToken |
        | refresh_token_et | int | RefreshToken有效期，秒级时间戳 |
        | company_id | string | CompanyId |
        | app_id | string | AppId |
        | open_id | string | 用户的OpenId |
        | union_id | string | 用户的UnionId |
    - 示例
    
        ```json
        {
          "code": 1,
          "data": {
            "access_token": "ShjzI1NiIsInR5cCI6IkpXVCJ9qeyJhIjoiQXBwSWRGb3JUZXN0IiwibyI6ImUxN2FkMTZiNTg4NDU3YzM4NDAyNGIxYWNmZGJhZTExIiwiZXhwIjoxNTUwNzQwOTcwLCJuYmYiOjE1NTA2NTQ1NzB9qvEGC1RExOq-lAAVllJEDMB9ztMYDtePGDXgaQjJAoMM",
            "access_token_et": 1551373323,
            "refresh_token": "heYzI1NiIsInR5cCI6IkpXVCJ9YeyJvIjoiZTE3YWQxNmI1ODg0NTdjMzg0MDI0YjFhY2ZkYmFlMTEiLCJhIjoiQXBwSWRGb3JUZXN0IiwiZXhwIjoxNTUwNzQwOTcwLCJuYmYiOjE1NTA2NTQ1NzB9Yz6cg_xPXb3QYwmLisclZfDRQ0kSGdB5G4QbktAk7YeE",
            "refresh_token_et": 1554051723,
            "scopes": [1],
            "company_id": "testcompanyid",
            "app_id": "testappid",
            "open_id": "e17ad16b588457c384024b1acfdbae11",
            "union_id": "36a38dc9461a55f5b8fbac3c9d3bfd8a"
          },
          "msg": "",
          "ok": true
        }
        ```

1. 刷新AccessToken
    - 请求方式：POST，接入方服务端调用
    - url：`https://{host}/api/v1/login/refresh/`
    - 传入值：

        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | access_token | string | 申请登录授权时拿到的AccessToken |
        | refresh_token | string | 该AccessCode对应的RefreshToken |
    - 返回值data信息：
        
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | access_token | string | 授权登录拿到的AccessToken |
        | access_token_et | int | AccessToken有效期，秒级时间戳 |
        | refresh_token | string | 授权登录拿到的RefreshToken |
        | refresh_token_et | int | RefreshToken有效期，秒级时间戳 |
        | scopes | []int | [此AccessToken获得的权限][scopes] |
    - 示例
    
        ```json
        {
          "code": 1,
          "data": {
            "access_token": "RRchbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9VeyJhIjoiQXBwSWRGb3JUZXN0IiwibyI6ImUxN2FkMTZiNTg4NDU3YzM4NDAyNGIxYWNmZGJhZTExIiwiZXhwIjoxNTUwNzQwOTk1LCJuYmYiOjE1NTA2NTQ1OTV9VOtrzL4-xKsxQtIElG88LSW7mshRT69DD0mxjvq",
            "access_token_et": 1552373323,
            "refresh_token": "2bFhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ92eyJvIjoiZTE3YWQxNmI1ODg0NTdjMzg0MDI0YjFhY2ZkYmFlMTEiLCJhIjoiQXBwSWRGb3JUZXN0IiwiZXhwIjoxNTUwNzQwOTk1LCJuYmYiOjE1NTA2NTQ1OTV92L4QyUy0Qfahqm9AvtkrDYb7QMO-baYIiaseIUY",
            "refresh_token_et": 1555051723,
            "scopes": [1]
          },
          "msg": "",
          "ok": true
        }
        ```


1. 主动将AccessToken下线
    - 请求方式：POST，接入方客户端调用
    - url：`https://{host}/api/v1/login/logout/`
    - 传入值：无，仅能将当前AccessToken下线
    - 返回值data信息：无
    - 示例
    
        ```json
        {
          "code": 1,
          "data": {},
          "msg": "",
          "ok": true
        }
        ```

1. 主动将AccessToken下线
    - 请求方式：POST，接入方服务端调用
    - url：`https://{host}/api/v1/login/logout/`
    - 传入值：
    
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | access_token | string | accessToken |
    - 返回值data信息：无
    - 示例
    
        ```json
        {
          "code": 1,
          "data": {},
          "msg": "",
          "ok": true
        }
        ```
        
1. 获取授权用户的信息
    - 请求方式：POST，由接入方客户端调用
    - url：`https://{host}/api/v1/user/detail/`
    - 传入值：无，仅能获取当前登录用户信息
    - 返回值data信息：
        
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | company_id | string | CompanyId |
        | app_id | string | AppId |
        | open_id | string | 用户的OpenId |
        | union_id | string | 用户的UnionId |
    - 示例
    
        ```json
        {
          "code": 1,
          "data": {
            "company_id": "testcompanyid",
            "app_id": "testappid",
            "open_id": "e17ad16b588457c384024b1acfdbae11",
            "union_id": "36a38dc9461a55f5b8fbac3c9d3bfd8a"
          },
          "msg": "",
          "ok": true
        }
        ```

1. 获取授权用户的信息
    - 请求方式：POST，由接入方服务端调用
    - url：`https://{host}/api/v1/user/detail/`
    - 传入值：

        | 参数名称 | 数据类型 | 说明 |
        | --- | --- | --- |
        | open_id | string | 要查询的用户的OpenId |
    - 返回值data信息：
        
        | 字段名 | 数据类型 | 说明 |
        | --- | --- | --- |
        | company_id | string | CompanyId |
        | app_id | string | AppId |
        | open_id | string | 用户的OpenId |
        | union_id | string | 用户的UnionId |
    - 示例
    
        ```json
        {
          "code": 1,
          "data": {
            "company_id": "testcompanyid",
            "app_id": "testappid",
            "open_id": "e17ad16b588457c384024b1acfdbae11",
            "union_id": "36a38dc9461a55f5b8fbac3c9d3bfd8a"
          },
          "msg": "",
          "ok": true
        }
        ```
        

[payorderstatus]: <./5.附录.md/#订单状态> "订单状态"
[payorderdirection]: <./5.附录.md/#转帐方向> "转帐方向"
[scopes]: <./5.附录.md/#权限> "可申请权限"
[接入方的链接]: <#接入方需提供的跳转页面>
[访问DragonEx授权登录页面]: <#接入方请求DragonEx提供的前端页面>
[拿到AccessCode跳转到接入方的地址]: <#接入方需提供的跳转页面>