# 对接流程示意

1. 对接流程

![对接流程][0]

    说明：
        1. 每个APP需绑定一个管理员账号，此账号可用于创建或修改Access Key，支付回调地址等信息，且此账号会冻结交易、提现等权限
        2. 管理员账号不支持修改，建议使用公司邮箱注册，避免因公司人员变动导致的后续问题
        3. 同一个公司旗下的多个APP拿到的comany_id是一样的，但是app_id不一样
        4. company_id与app_id由数字、小写字母组成，不会有大写字母或特殊字符，且以小写字母开头
        5. APP接入后即可获得登录的权限，若需要支付权限，需要另外申请

2. 数据结构示意

![数据结构示意][1]

    说明：
        1. 用户在登录或支付时，需要通过接入方的服务端与DragonEx服务端进行交互，交互时通过AccessKey与SecretKey密钥对进行鉴权
        2. 同一个APP可同时创建多个密钥对（暂定不多于5个）
        3. 每个密钥对可以均可以绑定不同的多个IP，若没有绑定则不对IP做校验
        
        1. 每个用户在授权登录后，会绑定一个UnionId跟一个OpenId
        2. 同一个用户在同一个公司下的多款APP中UnionId一样
        3. 同一个用户的OpenId间没有联系（不保证一样也不保证不一样）
        4. UnionId与OpenId一旦创建就保持不变，即使用户取消授权后重新授权也不会改变
        
        1. 用户授权登录后，会返回一对AccessToken与RefreshToken作为授权标识
        2. AccessToken与RefreshToken拥有不同的有效期，其中AccessToken有效期较短（24H以内），RefreshToken有效期较长（24*7H以上）
        3. 在RefreshToken有效期内，可以使用AccessToken与RefreshToken申请更换新Token，无需再通过用户授权
        4. AccessToken可由接入方主动下线，若无主动下线，在有效期前均可用
        5. 若用户取消对该APP的授权，对应的AccessToken也会失效
        6. 每一对AccessToken与RefreshToken配有不同的权限，由用户授权时选择，此权限应为接入方APP拥有的权限的子集
        7. 在该AccessToken有效期内，可使用AccessToken访问用户授权的资源
        8. 每对AccessToken会与申请此AccessToken时的设备绑定，仅允许通过此设备访问用户资源
        
        1. 支付时的trans_no由接入方提供，接入方需保证此值的唯一性
        2. 支付成功后，DragonEx会回调给接入方填写的回调地址，收到200 HTTP响应即认为回调成功；若回调失败会在36H内每隔10min重试一次，36H后仍旧回调失败的不再重试
        3. 对于支付失败的订单，DragonEx不会回调，接入方可用同样的trans_no重新申请支付，也可使用新的trans_no重新申请支付
        4. DragonEx会提供接口让接入方主动触发回调，此接口即使是失败的订单也回调（由status标识订单状态）
        5. DragonEx不保证同一个订单只回调一次，故接入方需要保证回调请求幂等
        6. 若订单长时间处于支付转账中的状态，请联系DragonEx进行处理
        
3. 通过DragonEx H5进行登录

![通过DragonEx H5进行登录][2]

    说明：
        1. 用户同意授权后，DragonEx会提供一个AccessCode，并携带此参数跳转到接入方指定的地址
        2. 接入方拿到AccessCode后，需要由接入方服务端带着此AccessCode，以及AccessKey及其签名校验请求DragonEx，获取AccessToken，签名方式见后续说明
        3. AccessKey与SecretKey是重要信息，请勿跟随客户端分发
        
<!--4. 通过DragonEx APP进行登录-->

<!--![通过DragonEx APP进行登录][3]-->

<!--    说明：-->
<!--        1. 除AccessCode参数的传递方式有点差别外，其余与H5登录方式一致-->

5. 通过DragonEx H5进行支付

![通过DragonEx H5进行支付][4]

    说明：
        1. 支付成功后，除了跟随HTTP请求返回支付状态外，还会有异步回调告诉接入方Server端
        2. DragonEx无法保证HTTP请求与回调到达的先后顺序，需接入方自行处理可能出现的情况

<!--6. 通过DragonEx APP进行支付-->

<!--![通过DragonEx APP进行支付][5]-->

<!--    说明：-->
<!--        1. 除支付Code参数的传递方式有点差别外，其余与H5支付方式一致-->


[0]: <https://exproductdiag891.blob.core.windows.net/oauth/docs/cn/DragonEx开放平台-对接流程.png> "对接流程"
[1]: <https://exproductdiag891.blob.core.windows.net/oauth/docs/cn/DragonEx开放平台-数据结构.png> "数据结构"
[2]: <https://exproductdiag891.blob.core.windows.net/oauth/docs/cn/DragonEx开放平台-通过H5认证时序图.png> "H5认证"
[3]: <https://exproductdiag891.blob.core.windows.net/oauth/docs/cn/DragonEx开放平台-通过APP认证时序图.png> "APP认证"
[4]: <https://exproductdiag891.blob.core.windows.net/oauth/docs/cn/DragonEx开放平台-通过H5支付时序图.png> "H5认证"
[5]: <https://exproductdiag891.blob.core.windows.net/oauth/docs/cn/DragonEx开放平台-通过APP支付时序图.png> "APP支付"